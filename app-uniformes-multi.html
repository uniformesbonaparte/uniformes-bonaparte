<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Uniformes Escolares Bonaparte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f3f3;
      margin: 0;
      padding: 0;
    }

    header {
      background: #003366;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      margin-bottom: 12px;
      border-radius: 5px;
      border: 1px solid #aaa;
    }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: white;
      background: #004c99;
      font-size: 15px;
      margin-right: 5px;
    }

    button.secondary {
      background: #555;
    }

    .card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }

    .hidden {
      display: none;
    }

    .pedido-item {
      background: #eef2f7;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
    }

    .img-thumb {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 6px;
      cursor: pointer;
    }

    .row {
      display: flex;
      gap: 10px;
    }

    .col {
      flex: 1;
    }
  </style>
</head>

<body>

<header>Uniformes Escolares Bonaparte</header>

<div class="container">

  <!-- LOGIN -->
  <section id="loginSection" class="card">
    <h2>Iniciar sesión</h2>
    <input id="loginEmail" type="email" placeholder="Correo">
    <input id="loginPassword" type="password" placeholder="Contraseña">
    <button onclick="login()">Entrar</button>
    <div id="loginError" style="color:red;margin-top:10px;"></div>
  </section>

  <!-- APP -->
  <section id="appSection" class="hidden">

    <h2>Panel de Usuario</h2>
    <div id="userInfo"></div>
    <button onclick="logout()" class="secondary">Cerrar sesión</button>

    <hr>

    <!-- ADMIN: gestión de usuarios -->
    <section id="usuariosCard" class="card hidden">
      <h3>Usuarios</h3>
      <div id="listaUsuarios"></div>

      <h4>Crear nuevo usuario</h4>
      <input id="newUserNombre" placeholder="Nombre">
      <input id="newUserEmail" placeholder="Correo">
      <input id="newUserPass" placeholder="Contraseña">
      <select id="newUserRol">
        <option value="admin">admin</option>
        <option value="ventas">ventas</option>
        <option value="compras">compras</option>
        <option value="corte">corte</option>
        <option value="confeccion">confeccion</option>
      </select>
      <button onclick="crearUsuario()">Crear usuario</button>
    </section>

    <!-- PEDIDOS -->
    <section class="card">
      <h3>Crear / Editar Pedido</h3>
      <input id="pedidoId" type="hidden">

      <input id="clienteNombre" placeholder="Nombre del cliente">
      <input id="clienteTelefono" placeholder="Teléfono">
      <input id="clienteEscuela" placeholder="Escuela">
      <input id="prendaTipo" placeholder="Tipo de prenda">
      <input id="prendaModelo" placeholder="Modelo">
      <textarea id="descripcionGeneral" placeholder="Descripción general"></textarea>
      <input id="fechaEntrega" type="date">

      <textarea id="tallasTexto" placeholder="Tallas y cantidades"></textarea>

      <input id="precioTotal" placeholder="Precio total">
      <input id="anticipo" placeholder="Anticipo">
      <input id="saldo" placeholder="Saldo">
      <input id="gastosCompras" placeholder="Gastos compras">

      <select id="estado">
        <option value="nuevo">nuevo</option>
        <option value="compras">compras</option>
        <option value="corte">corte</option>
        <option value="confeccion">confeccion</option>
        <option value="listo">listo</option>
        <option value="entregado">entregado</option>
      </select>

      <button onclick="guardarPedido()">Guardar Pedido</button>
    </section>

    <!-- SUBIR IMAGEN -->
    <section class="card">
      <h3>Imágenes del pedido</h3>
      <input id="imagenPedidoInput" type="file">
      <button onclick="subirImagen()">Subir imagen</button>
      <div id="imagenesLista"></div>
    </section>

    <!-- LISTA DE PEDIDOS -->
    <section class="card">
      <h3>Lista de Pedidos</h3>
      <div id="listaPedidos"></div>
    </section>

    <!-- RESPALDO -->
    <section class="card">
      <h3>Respaldos</h3>
      <button onclick="descargarRespaldo()">Descargar respaldo (.json)</button>
      <p>Guarda tus respaldos en tu compu o Drive.</p>
    </section>

  </section>
</div>

<script>
/* ================================
        VARIABLES GLOBALES
=============================== */
let API_BASE = window.location.origin + "/api";
let SERVER_BASE = window.location.origin;

let authToken = null;
let usuarioActual = null;

/* ================================
            LOGIN
=============================== */
async function login() {
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  const err = document.getElementById("loginError");
  err.textContent = "";

  if (!email || !password) {
    err.textContent = "Llena los campos.";
    return;
  }

  try {
    const res = await fetch(API_BASE + "/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });

    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      err.textContent = data.error || "Error al iniciar sesión.";
      return;
    }

    const data = await res.json();
    authToken = data.token;
    usuarioActual = { nombre: data.nombre, rol: data.rol };

    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("appSection").classList.remove("hidden");
    document.getElementById("userInfo").textContent =
      usuarioActual.nombre + " (" + usuarioActual.rol + ")";

    applyRoleUI();
    cargarPedidos();
    if (esAdmin()) cargarUsuarios();

  } catch (e) {
    err.textContent = "No se pudo conectar al servidor.";
  }
}

function logout() {
  authToken = null;
  usuarioActual = null;
  document.getElementById("appSection").classList.add("hidden");
  document.getElementById("loginSection").classList.remove("hidden");
}

/* ================================
            ROLES
=============================== */
function esAdmin() {
  return usuarioActual && usuarioActual.rol === "admin";
}

function applyRoleUI() {
  document.getElementById("usuariosCard").classList.toggle("hidden", !esAdmin());
}

/* ================================
        USUARIOS (ADMIN)
=============================== */
async function cargarUsuarios() {
  const cont = document.getElementById("listaUsuarios");
  cont.innerHTML = "";

  const res = await fetch(API_BASE + "/users", {
    headers: { "Authorization": "Bearer " + authToken }
  });

  const lista = await res.json();

  lista.forEach(u => {
    const div = document.createElement("div");
    div.textContent = `${u.id} - ${u.nombre} (${u.rol})`;
    cont.appendChild(div);
  });
}

async function crearUsuario() {
  const nombre = document.getElementById("newUserNombre").value.trim();
  const email = document.getElementById("newUserEmail").value.trim();
  const pass = document.getElementById("newUserPass").value.trim();
  const rol = document.getElementById("newUserRol").value;

  if (!nombre || !email || !pass) {
    alert("Llena todos los campos.");
    return;
  }

  await fetch(API_BASE + "/users", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + authToken,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ nombre, email, password: pass, rol })
  });

  cargarUsuarios();
}

/* ================================
        PEDIDOS
=============================== */
async function cargarPedidos() {
  const res = await fetch(API_BASE + "/pedidos", {
    headers: { "Authorization": "Bearer " + authToken }
  });

  const lista = await res.json();
  const cont = document.getElementById("listaPedidos");
  cont.innerHTML = "";

  lista.forEach(p => {
    const div = document.createElement("div");
    div.className = "pedido-item";
    div.innerHTML = `
      <b>${p.folio}</b> - ${p.prendaTipo} (${p.estado})<br>
      Cliente: ${p.clienteNombre}<br>
      <button onclick="cargarPedido(${p.id})">Editar</button>
    `;
    cont.appendChild(div);
  });
}

async function cargarPedido(id) {
  const res = await fetch(API_BASE + "/pedidos", {
    headers: { "Authorization": "Bearer " + authToken }
  });
  const lista = await res.json();
  const p = lista.find(x => x.id === id);

  document.getElementById("pedidoId").value = id;
  document.getElementById("clienteNombre").value = p.clienteNombre;
  document.getElementById("clienteTelefono").value = p.clienteTelefono;
  document.getElementById("clienteEscuela").value = p.clienteEscuela;

  document.getElementById("prendaTipo").value = p.prendaTipo;
  document.getElementById("prendaModelo").value = p.prendaModelo;

  document.getElementById("descripcionGeneral").value = p.descripcionGeneral;
  document.getElementById("fechaEntrega").value = p.fechaEntrega;
  document.getElementById("tallasTexto").value = p.tallasTexto;

  document.getElementById("precioTotal").value = p.precioTotal;
  document.getElementById("anticipo").value = p.anticipo;
  document.getElementById("saldo").value = p.saldo;
  document.getElementById("gastosCompras").value = p.gastosCompras;

  document.getElementById("estado").value = p.estado;

  cargarImagenes(id);
}

async function guardarPedido() {
  const id = document.getElementById("pedidoId").value;
  const payload = {
    clienteNombre: clienteNombre.value,
    clienteTelefono: clienteTelefono.value,
    clienteEscuela: clienteEscuela.value,
    prendaTipo: prendaTipo.value,
    prendaModelo: prendaModelo.value,
    descripcionGeneral: descripcionGeneral.value,
    fechaEntrega: fechaEntrega.value,
    tallasTexto: tallasTexto.value,
    precioTotal: precioTotal.value,
    anticipo: anticipo.value,
    saldo: saldo.value,
    gastosCompras: gastosCompras.value,
    estado: estado.value
  };

  const url = API_BASE + "/pedidos" + (id ? "/" + id : "");

  await fetch(url, {
    method: id ? "PUT" : "POST",
    headers: {
      "Authorization": "Bearer " + authToken,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });

  cargarPedidos();
  alert("Pedido guardado.");
}

/* ================================
        IMÁGENES
=============================== */
async function subirImagen() {
  const id = document.getElementById("pedidoId").value;
  if (!id) {
    alert("Primero guarda el pedido.");
    return;
  }

  const fileInput = document.getElementById("imagenPedidoInput");
  if (!fileInput.files.length) return;

  const formData = new FormData();
  formData.append("imagen", fileInput.files[0]);

  await fetch(API_BASE + `/pedidos/${id}/imagen`, {
    method: "POST",
    headers: { "Authorization": "Bearer " + authToken },
    body: formData
  });

  fileInput.value = "";
  cargarImagenes(id);
}

async function cargarImagenes(id) {
  const res = await fetch(API_BASE + `/pedidos/${id}/imagenes`, {
    headers: { "Authorization": "Bearer " + authToken }
  });

  const lista = await res.json();
  const cont = document.getElementById("imagenesLista");
  cont.innerHTML = "";

  lista.forEach(img => {
    const image = document.createElement("img");
    image.src = SERVER_BASE + img.imagenUrl;
    image.className = "img-thumb";
    image.onclick = () => window.open(image.src, "_blank");
    cont.appendChild(image);
  });
}

/* ================================
        RESPALDO
=============================== */
async function descargarRespaldo() {
  if (!esAdmin()) {
    alert("Solo el admin puede respaldar.");
    return;
  }

  const res = await fetch(API_BASE + "/respaldo", {
    headers: { "Authorization": "Bearer " + authToken }
  });

  if (!res.ok) {
    alert("Error al generar respaldo.");
    return;
  }

  const data = await res.json();
  const contenido = JSON.stringify(data, null, 2);
  const blob = new Blob([contenido], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "respaldo-bonaparte.json";
  a.click();
  URL.revokeObjectURL(url);
}

</script>
</body>
</html>
