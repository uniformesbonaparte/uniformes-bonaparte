<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Uniformes Escolares Bonaparte · Sistema de pedidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --azul-oscuro: #041527;
      --azul: #0b3a73;
      --azul-claro: #e0ecff;
      --rojo: #e4272b;
      --gris-fondo: #f3f4f6;
      --gris-card: #ffffff;
      --gris-borde: #d1d5db;
      --texto: #111827;
      --texto-suave: #6b7280;
      --radius: 14px;
      --shadow: 0 10px 28px rgba(15, 23, 42, 0.25);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top left, #102241 0, #020617 50%, #030712 100%);
      color: var(--texto);
    }

    header {
      background: rgba(3, 15, 35, 0.96);
      backdrop-filter: blur(10px);
      color: #f9fafb;
      padding: 12px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(148, 163, 184, 0.5);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid rgba(148,163,184,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .brand-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .brand-text-main {
      font-size: 17px;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      line-height: 1.1;
    }

    .brand-text-sub {
      font-size: 11px;
      color: #cbd5f5;
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    main {
      max-width: 1200px;
      margin: 16px auto 24px;
      padding: 0 12px 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.6fr);
      gap: 14px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: radial-gradient(circle at top, #ffffff 0, #f9fafb 50%, #f3f4f6 100%);
      border-radius: var(--radius);
      padding: 12px 14px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(148,163,184,0.6);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(130deg, rgba(11,58,115,0.12), rgba(228,39,43,0.08));
      opacity: 0.85;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card h2, .card h3 {
      margin: 0 0 6px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--texto);
    }

    .card h2::before {
      content: "";
      width: 22px;
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--azul), var(--rojo));
    }

    .card h3 {
      font-size: 14px;
      margin-top: 10px;
    }

    label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #374151;
      display: block;
      margin-bottom: 2px;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 9px;
      border: 1px solid var(--gris-borde);
      font-size: 13px;
      background: #f9fafb;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--azul);
      box-shadow: 0 0 0 1px rgba(11,58,115,0.45);
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }

    .row-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 750px) {
      .row, .row-3 {
        grid-template-columns: 1fr;
      }
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 7px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--azul), #052f5f);
      color: #f9fafb;
      font-size: 13px;
      cursor: pointer;
      margin-top: 6px;
      box-shadow: 0 8px 16px rgba(15,23,42,0.35);
      transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;
      white-space: nowrap;
    }

    .btn.secondary {
      background: linear-gradient(135deg, #e5e7eb, var(--azul-claro));
      color: #111827;
      box-shadow: 0 6px 12px rgba(148,163,184,0.5);
    }

    .btn.danger {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      color: #f9fafb;
      box-shadow: 0 6px 12px rgba(248,113,113,0.6);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(1.03);
      box-shadow: 0 10px 22px rgba(15,23,42,0.45);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 4px 9px rgba(15,23,42,0.35);
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
    }

    .small-text {
      font-size: 11px;
      color: var(--texto-suave);
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
      background: rgba(255,255,255,0.98);
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }

    th {
      background: linear-gradient(90deg, #e5e7eb, #dde7ff);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #374151;
    }

    tr:hover {
      background: #f9fafb;
      cursor: pointer;
    }

    .status-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148,163,184,0.8);
    }

    .s-nuevo { background: #dcfce7; }
    .s-compras { background: #dbeafe; }
    .s-corte { background: #fee2e2; }
    .s-confeccion { background: #f3e8ff; }
    .s-listo { background: #fef9c3; }
    .s-entregado { background: #bbf7d0; }

    #loginView {
      max-width: 400px;
      margin: 80px auto;
    }

    #appView {
      display: none;
    }

    #imagenesLista {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .thumb {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(148,163,184,0.6);
    }

    .thumb img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.15s;
    }

    .thumb img:hover {
      transform: scale(1.06);
    }

    #usuariosCard, #resumenCard {
      max-width: 1200px;
      margin: 10px auto 0;
      padding: 0 12px;
    }
  </style>

  <!-- Librería para generar PDF en el navegador -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginView">
    <section class="card">
      <div class="card-inner">
        <h2>Acceso · Uniformes Bonaparte</h2>
        <p class="small-text">
          Usuario de prueba:<br>
          <b>Correo:</b> admin@local<br>
          <b>Contraseña:</b> admin123
        </p>
        <label for="loginEmail">Correo</label>
        <input id="loginEmail" type="email" placeholder="admin@local" />
        <label for="loginPassword">Contraseña</label>
        <input id="loginPassword" type="password" placeholder="••••••••" />
        <button class="btn" onclick="login()">Entrar</button>
        <div id="loginError" class="small-text" style="color:#b91c1c; margin-top:6px;"></div>
      </div>
    </section>
  </div>

  <!-- APP -->
  <div id="appView">
    <header>
      <div class="brand">
        <div class="brand-logo">
          <img src="logo-bonaparte.jpg" alt="Logo Bonaparte" />
        </div>
        <div>
          <div class="brand-text-main">UNIFORMES ESCOLARES BONAPARTE</div>
          <div class="brand-text-sub">Control de pedidos · Taller y producción</div>
        </div>
      </div>
      <div class="top-right">
        <span id="userInfo"></span>
        <button class="btn secondary" onclick="logout()">Salir</button>
      </div>
    </header>

    <main>
      <div class="grid">
        <!-- LISTA DE PEDIDOS -->
        <section class="card">
          <div class="card-inner">
            <h2>Pedidos</h2>
            <div class="row" style="margin-bottom:4px;">
              <div>
                <label for="filtroTexto">Buscar</label>
                <input id="filtroTexto" type="text" placeholder="Cliente o escuela" oninput="renderPedidos()" />
              </div>
              <div>
                <label for="filtroEstado">Estado</label>
                <select id="filtroEstado" onchange="renderPedidos()">
                  <option value="">Todos</option>
                  <option value="nuevo">Nuevo</option>
                  <option value="compras">Compras</option>
                  <option value="corte">Corte</option>
                  <option value="confeccion">Confección</option>
                  <option value="listo">Listo</option>
                  <option value="entregado">Entregado</option>
                </select>
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Folio</th>
                  <th>Cliente</th>
                  <th>Escuela</th>
                  <th>Entrega</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody id="tablaPedidosBody"></tbody>
            </table>
            <div class="small-text">Haz clic en un pedido para editarlo.</div>
            <button class="btn" style="margin-top:6px;" id="btnNuevoPedido" onclick="nuevoPedido()">Nuevo pedido</button>
          </div>
        </section>

        <!-- FORMULARIO -->
        <section class="card" id="formPedidoCard">
          <div class="card-inner">
            <h2 id="tituloFormulario">Nuevo pedido</h2>
            <input type="hidden" id="pedidoId" />
            <input type="hidden" id="imagenUrl" />

            <h3>Datos del cliente</h3>
            <div class="row">
              <div>
                <label for="clienteNombre">Nombre</label>
                <input id="clienteNombre" type="text" />
              </div>
              <div id="clienteTelefonoGroup">
                <label for="clienteTelefono">Teléfono</label>
                <input id="clienteTelefono" type="text" />
              </div>
            </div>
            <label for="clienteEscuela">Escuela / Empresa</label>
            <input id="clienteEscuela" type="text" />

            <h3>Datos del pedido</h3>
            <div class="row">
              <div>
                <label for="prendaTipo">Tipo de prenda</label>
                <input id="prendaTipo" type="text" placeholder="Polo, pants, falda..." />
              </div>
              <div>
                <label for="prendaModelo">Modelo / Referencia</label>
                <input id="prendaModelo" type="text" />
              </div>
            </div>
            <label for="descripcionGeneral">Descripción general</label>
            <textarea id="descripcionGeneral" placeholder="Colores, logo, detalles importantes..."></textarea>

            <div class="row" style="margin-top:4px;">
              <div>
                <label for="fechaEntrega">Fecha de entrega</label>
                <input id="fechaEntrega" type="date" />
              </div>
              <div>
                <label for="estado">Estado</label>
                <select id="estado">
                  <option value="nuevo">Nuevo</option>
                  <option value="compras">Compras</option>
                  <option value="corte">Corte</option>
                  <option value="confeccion">Confección</option>
                  <option value="listo">Listo</option>
                  <option value="entregado">Entregado</option>
                </select>
              </div>
            </div>

            <h3>Tallas y cantidades</h3>
            <label for="tallasTexto">Tallas</label>
            <textarea id="tallasTexto" placeholder="Ej. 10 pzas 6, 15 pzas 8, 8 pzas 10..."></textarea>

            <h3>Notas por área</h3>
            <div class="row">
              <div>
                <label for="comprasNotas">Compras</label>
                <textarea id="comprasNotas" placeholder="Tela, accesorios, insumos..."></textarea>
              </div>
              <div>
                <label for="corteNotas">Corte</label>
                <textarea id="corteNotas" placeholder="Detalles de trazo y corte..."></textarea>
              </div>
            </div>
            <label for="confeccionNotas">Confección</label>
            <textarea id="confeccionNotas" placeholder="Detalles de costura, terminados..."></textarea>

            <!-- FINANZAS (solo admin/ventas/compras) -->
            <div id="finanzasSection">
              <h3>Finanzas</h3>
              <div class="row-3">
                <div>
                  <label for="precioTotal">Precio total ($)</label>
                  <input id="precioTotal" type="number" step="0.01" />
                </div>
                <div>
                  <label for="anticipo">Anticipo ($)</label>
                  <input id="anticipo" type="number" step="0.01" />
                </div>
                <div>
                  <label for="saldo">Saldo ($)</label>
                  <input id="saldo" type="number" step="0.01" />
                </div>
              </div>
              <label for="gastosCompras">Gastos compras ($)</label>
              <input id="gastosCompras" type="number" step="0.01" />

              <div id="condicionesWrapper">
                <h3>Condiciones del pedido (cliente)</h3>
                <label for="condicionesCliente">Condiciones</label>
                <textarea id="condicionesCliente"
                  placeholder="Ej. Tiempo de entrega, cambios, forma de pago, garantías..."></textarea>
              </div>

              <div id="comprasDetalleWrapper">
                <h3>Detalle de compras (insumos)</h3>
                <label for="comprasDetalle">Detalle de compras</label>
                <textarea id="comprasDetalle"
                  placeholder="Ej. Tela Oxford azul | 25 m | $80/m | Proveedor X&#10;Botones metálicos | 200 pzas | $1.5 c/u | Proveedor Y"></textarea>
                <div class="small-text">
                  Una línea por insumo (tipo | cantidad | unidad | precio | proveedor).
                </div>
              </div>
            </div>

            <h3>Imágenes de referencia</h3>
            <div class="row">
              <div>
                <label for="imagenArchivo">Imagen (una por vez)</label>
                <input id="imagenArchivo" type="file" accept="image/*" />
                <button class="btn secondary" id="btnSubirImagen" onclick="subirImagen()">Subir imagen</button>
                <div class="small-text">Sube imágenes una por una ligadas al pedido.</div>
              </div>
              <div>
                <label>Vista previa</label>
                <img id="imagenPreview"
                     style="max-width:100%;max-height:150px;border-radius:10px;border:1px solid #e5e7eb;display:none;" />
              </div>
            </div>
            <label>Galería de imágenes</label>
            <div id="imagenesLista"></div>

            <div class="small-text" id="infoExtra" style="margin-top:6px;"></div>

            <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;">
              <button class="btn" id="btnGuardarPedido" onclick="guardarPedido()">Guardar pedido</button>
              <button class="btn secondary" id="btnLimpiarPedido" onclick="nuevoPedido()">Limpiar / nuevo</button>
              <button class="btn secondary" id="btnNotaPDF" onclick="exportarNotaPDF()">Nota PDF (cliente)</button>
              <button class="btn secondary" id="btnComprasPDF" onclick="exportarComprasPDF()">PDF compras</button>
              <button class="btn danger" id="btnEliminarPedido" onclick="eliminarPedido()">Eliminar pedido</button>
            </div>
          </div>
        </section>
      </div>
    </main>

    <!-- USUARIOS (ADMIN) -->
    <section class="card" id="usuariosCard" style="display:none;">
      <div class="card-inner">
        <h2>Usuarios por área</h2>
        <div class="row">
          <div>
            <label for="newUserNombre">Nombre</label>
            <input id="newUserNombre" type="text" placeholder="Ej. Compras" />
          </div>
          <div>
            <label for="newUserEmail">Correo</label>
            <input id="newUserEmail" type="email" placeholder="compras@taller.com" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="newUserPass">Contraseña</label>
            <input id="newUserPass" type="password" placeholder="••••••••" />
          </div>
          <div>
            <label for="newUserRol">Rol</label>
            <select id="newUserRol">
              <option value="admin">admin</option>
              <option value="ventas">ventas</option>
              <option value="compras">compras</option>
              <option value="corte">corte</option>
              <option value="confeccion">confeccion</option>
            </select>
          </div>
        </div>
        <button class="btn" onclick="crearUsuario()">Crear usuario</button>
        <h3>Lista de usuarios</h3>
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Nombre</th><th>Correo</th><th>Rol</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaUsuariosBody"></tbody>
        </table>
      </div>
    </section>

    <!-- RESUMEN + RESPALDO -->
    <section class="card" id="resumenCard" style="display:none;">
      <div class="card-inner">
        <h2>Resumen y respaldo</h2>
        <div id="resumenContenido" class="small-text"></div>
        <button class="btn secondary" style="margin-top:8px;" onclick="descargarRespaldo()">
          Descargar respaldo (.json)
        </button>
      </div>
    </section>
  </div>

  <script>
    const API_BASE = window.location.origin + "/api";
    const SERVER_BASE = window.location.origin;

    let authToken = null;
    let usuarioActual = null;
    let pedidos = [];
    let usuarios = [];

    function statusPill(estado) {
      const map = {
        "nuevo": { t: "Nuevo", c: "s-nuevo" },
        "compras": { t: "Compras", c: "s-compras" },
        "corte": { t: "Corte", c: "s-corte" },
        "confeccion": { t: "Confección", c: "s-confeccion" },
        "listo": { t: "Listo", c: "s-listo" },
        "entregado": { t: "Entregado", c: "s-entregado" }
      };
      const info = map[estado] || { t: estado, c: "" };
      return '<span class="status-pill ' + info.c + '">' + info.t + '</span>';
    }

    function esAdmin() {
      return usuarioActual && usuarioActual.rol === "admin";
    }

    function applyRoleUI() {
      const rol = usuarioActual ? usuarioActual.rol : "";

      const usuariosCard = document.getElementById("usuariosCard");
      const resumenCard = document.getElementById("resumenCard");
      if (usuariosCard) usuariosCard.style.display = esAdmin() ? "block" : "none";
      if (resumenCard) resumenCard.style.display = esAdmin() ? "block" : "none";

      const telGroup = document.getElementById("clienteTelefonoGroup");
      if (telGroup) {
        telGroup.style.display = (rol === "admin" || rol === "ventas") ? "block" : "none";
      }

      const finanzasSection = document.getElementById("finanzasSection");
      if (finanzasSection) {
        const showFin = (rol === "admin" || rol === "ventas" || rol === "compras");
        finanzasSection.style.display = showFin ? "block" : "none";
      }

      const condWrap = document.getElementById("condicionesWrapper");
      if (condWrap) {
        condWrap.style.display = (rol === "admin" || rol === "ventas") ? "block" : "none";
      }

      const comprasWrap = document.getElementById("comprasDetalleWrapper");
      if (comprasWrap) {
        comprasWrap.style.display = (rol === "admin" || rol === "compras") ? "block" : "none";
      }

      const btnNotaPDF = document.getElementById("btnNotaPDF");
      if (btnNotaPDF) {
        btnNotaPDF.style.display = (rol === "admin" || rol === "ventas") ? "inline-flex" : "none";
      }
      const btnComprasPDF = document.getElementById("btnComprasPDF");
      if (btnComprasPDF) {
        btnComprasPDF.style.display = (rol === "admin" || rol === "compras") ? "inline-flex" : "none";
      }

      const canEdit = (rol === "admin" || rol === "ventas" || rol === "compras");
      const formCard = document.getElementById("formPedidoCard");
      if (formCard) {
        const campos = formCard.querySelectorAll("input, select, textarea");
        campos.forEach(el => {
          if (el.id === "imagenArchivo") {
            el.disabled = !canEdit;
          } else {
            el.disabled = !canEdit && el.tagName !== "IMG";
          }
        });

        const btnGuardar = document.getElementById("btnGuardarPedido");
        const btnLimpiar = document.getElementById("btnLimpiarPedido");
        const btnSubir = document.getElementById("btnSubirImagen");
        const btnNuevo = document.getElementById("btnNuevoPedido");
        const btnEliminarPedido = document.getElementById("btnEliminarPedido");

        if (btnGuardar) btnGuardar.style.display = canEdit ? "inline-flex" : "none";
        if (btnLimpiar) btnLimpiar.style.display = canEdit ? "inline-flex" : "none";
        if (btnSubir) btnSubir.style.display = canEdit ? "inline-flex" : "none";
        if (btnNuevo) btnNuevo.style.display = canEdit ? "inline-flex" : "none";
        if (btnEliminarPedido) btnEliminarPedido.style.display = esAdmin() ? "inline-flex" : "none";
      }
    }

    async function login() {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      const err = document.getElementById("loginError");
      err.textContent = "";

      if (!email || !password) {
        err.textContent = "Llena correo y contraseña.";
        return;
      }

      try {
        const res = await fetch(API_BASE + "/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password })
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          err.textContent = data.error || "Error al iniciar sesión.";
          return;
        }

        const data = await res.json();
        authToken = data.token;
        usuarioActual = { nombre: data.nombre, rol: data.rol };

        document.getElementById("loginView").style.display = "none";
        document.getElementById("appView").style.display = "block";
        document.getElementById("userInfo").textContent =
          usuarioActual.nombre + " (" + usuarioActual.rol + ")";

        applyRoleUI();
        await cargarPedidos();
        if (esAdmin()) {
          await cargarUsuarios();
          actualizarResumen();
        }
      } catch (e) {
        err.textContent = "No se pudo conectar al servidor.";
      }
    }

    function logout() {
      authToken = null;
      usuarioActual = null;
      document.getElementById("appView").style.display = "none";
      document.getElementById("loginView").style.display = "block";
    }

    async function cargarPedidos() {
      if (!authToken) return;
      const res = await fetch(API_BASE + "/pedidos", {
        headers: { "Authorization": "Bearer " + authToken }
      });
      if (!res.ok) return;
      pedidos = await res.json();
      renderPedidos();
      actualizarResumen();
    }

    function renderPedidos() {
      const tbody = document.getElementById("tablaPedidosBody");
      tbody.innerHTML = "";
      const filtroTexto = document.getElementById("filtroTexto").value.toLowerCase().trim();
      const filtroEstado = document.getElementById("filtroEstado").value;

      let lista = pedidos.slice().sort((a,b) => (b.id || 0) - (a.id || 0));

      lista = lista.filter(p => {
        let okTexto = true;
        if (filtroTexto) {
          const t = ((p.clienteNombre || "") + " " + (p.clienteEscuela || "")).toLowerCase();
          okTexto = t.includes(filtroTexto);
        }
        let okEstado = true;
        if (filtroEstado) okEstado = p.estado === filtroEstado;
        return okTexto && okEstado;
      });

      for (const p of lista) {
        const tr = document.createElement("tr");
        tr.onclick = () => cargarPedido(p.id);
        tr.innerHTML = `
          <td>${p.folio || "-"}</td>
          <td>${p.clienteNombre || ""}</td>
          <td>${p.clienteEscuela || ""}</td>
          <td>${p.fechaEntrega || ""}</td>
          <td>${statusPill(p.estado)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function cargarPedido(id) {
      const p = pedidos.find(x => x.id === id);
      if (!p) return;

      document.getElementById("pedidoId").value = p.id;
      document.getElementById("clienteNombre").value = p.clienteNombre || "";
      document.getElementById("clienteTelefono").value = p.clienteTelefono || "";
      document.getElementById("clienteEscuela").value = p.clienteEscuela || "";
      document.getElementById("prendaTipo").value = p.prendaTipo || "";
      document.getElementById("prendaModelo").value = p.prendaModelo || "";
      document.getElementById("descripcionGeneral").value = p.descripcionGeneral || "";
      document.getElementById("fechaEntrega").value = p.fechaEntrega || "";
      document.getElementById("estado").value = p.estado || "nuevo";
      document.getElementById("tallasTexto").value = p.tallasTexto || "";
      document.getElementById("comprasNotas").value = p.comprasNotas || "";
      document.getElementById("corteNotas").value = p.corteNotas || "";
      document.getElementById("confeccionNotas").value = p.confeccionNotas || "";
      document.getElementById("precioTotal").value = p.precioTotal ?? "";
      document.getElementById("anticipo").value = p.anticipo ?? "";
      document.getElementById("saldo").value = p.saldo ?? "";
      document.getElementById("gastosCompras").value = p.gastosCompras ?? "";
      document.getElementById("condicionesCliente").value = p.condicionesCliente || "";
      document.getElementById("comprasDetalle").value = p.comprasDetalle || "";

      const imgPrev = document.getElementById("imagenPreview");
      if (p.imagenUrl) {
        imgPrev.src = SERVER_BASE + p.imagenUrl;
        imgPrev.style.display = "block";
      } else {
        imgPrev.src = "";
        imgPrev.style.display = "none";
      }

      document.getElementById("tituloFormulario").textContent =
        "Editar pedido " + (p.folio || "");
      document.getElementById("infoExtra").textContent =
        "ID: " + p.id + " · Estado: " + p.estado;

      await cargarImagenes(id);
    }

    function nuevoPedido() {
      document.getElementById("pedidoId").value = "";
      document.getElementById("clienteNombre").value = "";
      document.getElementById("clienteTelefono").value = "";
      document.getElementById("clienteEscuela").value = "";
      document.getElementById("prendaTipo").value = "";
      document.getElementById("prendaModelo").value = "";
      document.getElementById("descripcionGeneral").value = "";
      document.getElementById("fechaEntrega").value = "";
      document.getElementById("estado").value = "nuevo";
      document.getElementById("tallasTexto").value = "";
      document.getElementById("comprasNotas").value = "";
      document.getElementById("corteNotas").value = "";
      document.getElementById("confeccionNotas").value = "";
      document.getElementById("precioTotal").value = "";
      document.getElementById("anticipo").value = "";
      document.getElementById("saldo").value = "";
      document.getElementById("gastosCompras").value = "";
      document.getElementById("condicionesCliente").value = "";
      document.getElementById("comprasDetalle").value = "";
      document.getElementById("imagenUrl").value = "";
      document.getElementById("imagenPreview").style.display = "none";
      document.getElementById("imagenesLista").innerHTML = "";
      document.getElementById("tituloFormulario").textContent = "Nuevo pedido";
      document.getElementById("infoExtra").textContent = "";
    }

    async function guardarPedido() {
      if (!authToken) {
        alert("Primero inicia sesión.");
        return;
      }

      const id = document.getElementById("pedidoId").value;
      const payload = {
        clienteNombre: document.getElementById("clienteNombre").value.trim(),
        clienteTelefono: document.getElementById("clienteTelefono").value.trim(),
        clienteEscuela: document.getElementById("clienteEscuela").value.trim(),
        prendaTipo: document.getElementById("prendaTipo").value.trim(),
        prendaModelo: document.getElementById("prendaModelo").value.trim(),
        descripcionGeneral: document.getElementById("descripcionGeneral").value.trim(),
        fechaEntrega: document.getElementById("fechaEntrega").value,
        estado: document.getElementById("estado").value,
        tallasTexto: document.getElementById("tallasTexto").value.trim(),
        comprasNotas: document.getElementById("comprasNotas").value.trim(),
        corteNotas: document.getElementById("corteNotas").value.trim(),
        confeccionNotas: document.getElementById("confeccionNotas").value.trim(),
        precioTotal: parseFloat(document.getElementById("precioTotal").value || "0"),
        anticipo: parseFloat(document.getElementById("anticipo").value || "0"),
        saldo: parseFloat(document.getElementById("saldo").value || "0"),
        gastosCompras: parseFloat(document.getElementById("gastosCompras").value || "0"),
        condicionesCliente: document.getElementById("condicionesCliente").value.trim(),
        comprasDetalle: document.getElementById("comprasDetalle").value.trim(),
        imagenUrl: document.getElementById("imagenUrl").value || null
      };

      const url = API_BASE + "/pedidos" + (id ? "/" + id : "");
      const method = id ? "PUT" : "POST";

      const res = await fetch(url, {
        method,
        headers: {
          "Authorization": "Bearer " + authToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        alert(data.error || "Error al guardar pedido.");
        return;
      }

      alert("Pedido guardado.");
      await cargarPedidos();
      if (id) {
        cargarPedido(parseInt(id));
      } else {
        nuevoPedido();
      }
    }

    async function eliminarPedido() {
      if (!authToken || !esAdmin()) {
        alert("Solo admin puede eliminar pedidos.");
        return;
      }
      const id = document.getElementById("pedidoId").value;
      if (!id) {
        alert("Primero selecciona un pedido a eliminar.");
        return;
      }
      if (!confirm("¿Eliminar el pedido " + id + "? Esta acción no se puede deshacer.")) {
        return;
      }
      const res = await fetch(API_BASE + "/pedidos/" + id, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + authToken }
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        alert(data.error || "Error al eliminar pedido.");
        return;
      }
      alert("Pedido eliminado.");
      await cargarPedidos();
      nuevoPedido();
    }

    async function subirImagen() {
      if (!authToken) {
        alert("Primero inicia sesión.");
        return;
      }
      const id = document.getElementById("pedidoId").value;
      if (!id) {
        alert("Primero guarda el pedido.");
        return;
      }
      const fileInput = document.getElementById("imagenArchivo");
      if (!fileInput.files.length) {
        alert("Selecciona una imagen.");
        return;
      }

      const formData = new FormData();
      formData.append("imagen", fileInput.files[0]);

      const res = await fetch(API_BASE + "/pedidos/" + id + "/imagen", {
        method: "POST",
        headers: { "Authorization": "Bearer " + authToken },
        body: formData
      });

      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        alert(data.error || "Error al subir imagen.");
        return;
      }

      fileInput.value = "";
      await cargarImagenes(id);
      alert("Imagen subida.");
    }

    async function cargarImagenes(id) {
      if (!authToken) return;
      const res = await fetch(API_BASE + "/pedidos/" + id + "/imagenes", {
        headers: { "Authorization": "Bearer " + authToken }
      });
      if (!res.ok) return;
      const lista = await res.json();
      const cont = document.getElementById("imagenesLista");
      cont.innerHTML = "";

      const imgPrev = document.getElementById("imagenPreview");
      if (lista.length > 0) {
        const urlPrev = SERVER_BASE + lista[0].imagenUrl;
        imgPrev.src = urlPrev;
        imgPrev.style.display = "block";
      } else {
        imgPrev.src = "";
        imgPrev.style.display = "none";
      }

      lista.forEach(img => {
        const div = document.createElement("div");
        div.className = "thumb";
        const url = SERVER_BASE + img.imagenUrl;
        div.innerHTML = `<img src="${url}" onclick="window.open('${url}','_blank')" />`;
        cont.appendChild(div);
      });
    }

    async function cargarUsuarios() {
      if (!authToken || !esAdmin()) return;
      const res = await fetch(API_BASE + "/users", {
        headers: { "Authorization": "Bearer " + authToken }
      });
      if (!res.ok) return;
      usuarios = await res.json();
      const tbody = document.getElementById("tablaUsuariosBody");
      tbody.innerHTML = "";
      for (const u of usuarios) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.id}</td>
          <td>${u.nombre}</td>
          <td>${u.email}</td>
          <td>${u.rol}</td>
          <td>
            <button class="btn danger" onclick="eliminarUsuario(${u.id}); event.stopPropagation();">
              Eliminar
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function crearUsuario() {
      if (!authToken || !esAdmin()) {
        alert("Solo admin puede crear usuarios.");
        return;
      }
      const nombre = document.getElementById("newUserNombre").value.trim();
      const email = document.getElementById("newUserEmail").value.trim();
      const password = document.getElementById("newUserPass").value.trim();
      const rol = document.getElementById("newUserRol").value;
      if (!nombre || !email || !password) {
        alert("Llena todos los campos.");
        return;
      }

      const res = await fetch(API_BASE + "/users", {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + authToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ nombre, email, password, rol })
      });

      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        alert(data.error || "Error al crear usuario.");
        return;
      }

      document.getElementById("newUserNombre").value = "";
      document.getElementById("newUserEmail").value = "";
      document.getElementById("newUserPass").value = "";
      await cargarUsuarios();
      alert("Usuario creado.");
    }

    async function eliminarUsuario(id) {
      if (!authToken || !esAdmin()) {
        alert("Solo admin puede eliminar usuarios.");
        return;
      }
      if (!confirm("¿Eliminar usuario " + id + "? Esta acción no se puede deshacer.")) {
        return;
      }
      const res = await fetch(API_BASE + "/users/" + id, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + authToken }
      });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        alert(data.error || "Error al eliminar usuario.");
        return;
      }
      alert("Usuario eliminado.");
      await cargarUsuarios();
    }

    async function descargarRespaldo() {
      if (!authToken || !esAdmin()) {
        alert("Solo admin puede respaldar.");
        return;
      }

      const res = await fetch(API_BASE + "/respaldo", {
        headers: { "Authorization": "Bearer " + authToken }
      });

      if (!res.ok) {
        alert("No se pudo generar el respaldo.");
        return;
      }

      const data = await res.json();
      const contenido = JSON.stringify(data, null, 2);
      const blob = new Blob([contenido], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth() + 1).padStart(2, "0");
      const dd = String(hoy.getDate()).padStart(2, "0");

      const a = document.createElement("a");
      a.href = url;
      a.download = `respaldo-bonaparte-${yyyy}-${mm}-${dd}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      alert("Respaldo descargado.");
    }

    function actualizarResumen() {
      if (!esAdmin()) return;
      const div = document.getElementById("resumenContenido");
      let totalPedidos = pedidos.length;
      let totalVentas = 0;
      let totalGastos = 0;

      for (const p of pedidos) {
        totalVentas += parseFloat(p.precioTotal || 0);
        totalGastos += parseFloat(p.gastosCompras || 0);
      }
      const utilidad = totalVentas - totalGastos;

      div.innerHTML =
        "Pedidos: <b>" + totalPedidos + "</b><br>" +
        "Ventas totales: <b>$" + totalVentas.toFixed(2) + "</b><br>" +
        "Gastos compras: <b>$" + totalGastos.toFixed(2) + "</b><br>" +
        "Utilidad aprox: <b>$" + utilidad.toFixed(2) + "</b>";
    }

    function exportarNotaPDF() {
      if (!usuarioActual || (usuarioActual.rol !== "admin" && usuarioActual.rol !== "ventas")) {
        alert("Solo ventas o admin pueden generar la nota para cliente.");
        return;
      }
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) {
        alert("No se pudo cargar la librería de PDF.");
        return;
      }

      const id = document.getElementById("pedidoId").value;
      const pedido = pedidos.find(p => String(p.id) === String(id));
      const folio = pedido ? (pedido.folio || ("PED-" + pedido.id)) : "SIN-FOLIO";

      const doc = new jsPDF();

      const nombre = document.getElementById("clienteNombre").value || "";
      const escuela = document.getElementById("clienteEscuela").value || "";
      const tel = document.getElementById("clienteTelefono").value || "";
      const fechaEntrega = document.getElementById("fechaEntrega").value || "";
      const prendaTipo = document.getElementById("prendaTipo").value || "";
      const prendaModelo = document.getElementById("prendaModelo").value || "";
      const tallas = document.getElementById("tallasTexto").value || "";
      const precioTotal = document.getElementById("precioTotal").value || "0";
      const anticipo = document.getElementById("anticipo").value || "0";
      const saldo = document.getElementById("saldo").value || "0";
      const condiciones = document.getElementById("condicionesCliente").value || "";

      doc.setFontSize(14);
      doc.text("UNIFORMES ESCOLARES BONAPARTE", 10, 12);
      doc.setFontSize(11);
      doc.text("NOTA DE PEDIDO / VENTA", 10, 18);
      doc.text("Folio: " + folio, 150, 12);

      let y = 26;
      doc.setFontSize(10);
      doc.text("Cliente: " + nombre, 10, y); y += 5;
      doc.text("Escuela: " + escuela, 10, y); y += 5;
      if (tel) {
        doc.text("Teléfono: " + tel, 10, y); y += 5;
      }
      if (fechaEntrega) {
        doc.text("Fecha de entrega: " + fechaEntrega, 10, y); y += 7;
      } else {
        y += 2;
      }

      doc.setFontSize(11);
      doc.text("Detalle del pedido:", 10, y); y += 5;
      doc.setFontSize(10);
      doc.text("Prenda: " + prendaTipo, 10, y); y += 5;
      if (prendaModelo) {
        doc.text("Modelo/Ref.: " + prendaModelo, 10, y); y += 5;
      }

      if (tallas) {
        y += 3;
        doc.text("Tallas y cantidades:", 10, y); y += 5;
        const tallasLineas = tallas.split("\n");
        tallasLineas.forEach(l => {
          if (y > 270) { doc.addPage(); y = 20; }
          doc.text("- " + l, 12, y);
          y += 5;
        });
      }

      y += 4;
      doc.setFontSize(11);
      doc.text("Importes:", 10, y); y += 5;
      doc.setFontSize(10);
      doc.text("Precio total: $" + precioTotal, 10, y); y += 5;
      doc.text("Anticipo: $" + anticipo, 10, y); y += 5;
      doc.text("Saldo: $" + saldo, 10, y); y += 8;

      if (condiciones) {
        doc.setFontSize(11);
        doc.text("Condiciones del pedido:", 10, y); y += 5;
        doc.setFontSize(10);
        const condLineas = condiciones.split("\n");
        condLineas.forEach(l => {
          if (y > 270) { doc.addPage(); y = 20; }
          doc.text(l, 12, y);
          y += 5;
        });
      }

      y += 12;
      if (y > 270) { doc.addPage(); y = 20; }
      doc.setFontSize(10);
      doc.text("Firma de conformidad del cliente: ______________________________", 10, y);

      doc.save("nota-pedido-" + folio + ".pdf");
    }

    function exportarComprasPDF() {
      if (!usuarioActual || (usuarioActual.rol !== "admin" && usuarioActual.rol !== "compras")) {
        alert("Solo compras o admin pueden generar el PDF de compras.");
        return;
      }
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) {
        alert("No se pudo cargar la librería de PDF.");
        return;
      }

      const id = document.getElementById("pedidoId").value;
      const pedido = pedidos.find(p => String(p.id) === String(id));
      const folio = pedido ? (pedido.folio || ("PED-" + pedido.id)) : "SIN-FOLIO";

      const doc = new jsPDF();

      const nombre = document.getElementById("clienteNombre").value || "";
      const escuela = document.getElementById("clienteEscuela").value || "";
      const prendaTipo = document.getElementById("prendaTipo").value || "";
      const prendaModelo = document.getElementById("prendaModelo").value || "";
      const gastosCompras = document.getElementById("gastosCompras").value || "0";
      const comprasDetalle = document.getElementById("comprasDetalle").value || "";

      doc.setFontSize(14);
      doc.text("UNIFORMES ESCOLARES BONAPARTE", 10, 12);
      doc.setFontSize(11);
      doc.text("REPORTE DE COMPRAS POR PEDIDO", 10, 18);
      doc.text("Folio: " + folio, 150, 12);

      let y = 26;
      doc.setFontSize(10);
      doc.text("Cliente: " + nombre, 10, y); y += 5;
      doc.text("Escuela: " + escuela, 10, y); y += 5;
      doc.text("Prenda: " + prendaTipo, 10, y); y += 5;
      if (prendaModelo) {
        doc.text("Modelo/Ref.: " + prendaModelo, 10, y); y += 7;
      } else {
        y += 3;
      }

      doc.setFontSize(11);
      doc.text("Detalle de compras:", 10, y); y += 5;
      doc.setFontSize(10);

      if (comprasDetalle) {
        const lineas = comprasDetalle.split("\n");
        lineas.forEach(l => {
          if (y > 270) { doc.addPage(); y = 20; }
          doc.text("- " + l, 12, y);
          y += 5;
        });
      } else {
        doc.text("Sin detalle capturado.", 12, y); y += 5;
      }

      y += 6;
      doc.setFontSize(11);
      doc.text("Gasto total registrado (campo gastos compras): $" + gastosCompras, 10, y);

      doc.save("compras-pedido-" + folio + ".pdf");
    }
  </script>
</body>
</html>
